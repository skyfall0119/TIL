# 도커 볼륨을 이용한 퍼시스턴트 스토리지
- 컨테이너는 독립된 파일 시스템을 갖는다
- 도커가 여러 출처로부터 합쳐 만들고 컨테이너에 전달한 가상 파일 시스템
- 기록 가능 레이어
- 컨테이너를 실행할 때 생성, 삭제할때 함께 삭제

```
**커맨드**
볼륨 리스트 보기
docker volume ls 


컨테이너와 로컬 컴퓨터 간의 파일 복사
docker container cp [OPTION] CONTAINER:SRC_PATH dest_path

##  docker container cp url.txt f1:/input.txt
## 현재 경로의 url.txt 를 f1컨테이너에 input.txt 로 복사

```

- 같은 이미지에서 만들어진 컨테이너라도 파일을 공유하지 않음
- 도커 볼륨과 마운트는 컨테이너와는 별개의 생애주기를 갖음.
---

### 도커 볼륨을 사용하는 컨테이너
- 스토리지를 다루는 단위
- 컨테이너와 독립적으로 존재, 별도의 생애주기
- 컨테이너에 연결 가능
- 퍼시스턴시가 필요한 유상태 애플리케이션을 컨테이너로 실행하려면 볼륨 사용

1. 수동으로 볼륨 생성해 연결
2. Dockerfile 스크립트에서 VOLUME 인스트럭션 사용


```
...
# 멀티스테이지의 일부
FROM diamol/dotnet-aspnet
WORKDIR /app
ENTRYPOINT ["dotnet", "ToDoList.dll"]

VOLUME /data
COPY --from=builder /out/ .

...
```

- 이 이미지로 컨테이너를 실행하면 자동으로 볼륨을 생성해 컨테이너에 연결해줌 (/data)
- 컨테이너가 같은 볼륨을 공유하게 하려면 **--volumes-from** 사용

```
docker container run -d --name t3 --volumes-from todo1 diamol/ch06-todo-list
# 같은 이미지 diamol/ch06-todo-list 에서 만들어짐 
# todo1 에서 --volumes-from 을 사용해서 t3 과 todo1 이 볼륨을 공유함


```
---

<br/><br/>

*이미지에서 정의하는 것보단 명시적으로 관리하는 편이 훨씬 나음*

- 볼륨에 이름을 붙여 생성하고 업데이트시 다른 컨테이너로 옮겨 연결

```
볼륨 생성
docker volume create [VOLUMENAME]

볼륨 연결
docker container run -v [VOLUME]:TARGET_PATH

```
---

### 파일 시스템 마운트 사용하는 컨테이너
- 호스트 컴퓨터 파일 시스템디렉터리를 컨테이너 파일 시스템 디렉터리로
- 바인드 마운트는 양방향으로 동작함
- 한쪽에서 수정하면 다른쪽에서 수정된거 확인가능
- 호스트 컴퓨터 파이에 접근하기 위한 권한 상승 필요
    - dockerfile 스크립트에서 USER 인스트럭션 사용
```
#source="${pwd}\databases" && target='/data'

docker container run --mount type=bind, source=$source, target=$target

```

#### 한계점
- 컨테이너 마운트 대상 디렉터리가 이미 존재하고 이미지레이어에 이 디렉터리의 파일이 포함돼있다면?
    - 원본디렉터리가 기존 디렉터리를 완전히 대체해버림

- 호스트 컴퓨터의 파일 하나를 컨테이너에 이미 존재하는 디렉터리로 마운트하면?
    - 디렉터리의 파일이 합쳐져 이미지에서 온 파일과 호스트에서 마운트된 파일이 모두 나타남
    - 윈도우 컨테이너는 이 기능을 제공하지 않아 동작이 달라짐 (단일파일마운트 X)

- 분산파일 시스템을 컨테이너에 바인드 마운트하면? (드문 경우)
    - 윈도우 파일 공유 (SMB), 애저 파일스 (Azure Files), AWS S3 등
    - 일반적인 파일 시스템의 일부처럼 보일수 있음
    - 지원하지 않는 동작이 있을 수 있음

---

### 컨테이너 파일 시스템은 어떻게 만들어지나
- 도커가 다양한 출처로부터 모아 만든 단일 가상 디스크로 구성된 파일 시스템
- Union File System
- 컨테이너는 유니언 파일 시스템을 통해 물리적 위치가 서로 다른 파일과 디렉터리에 마치 단일 디스크를 사용하듯 접근 가능
- 여러개의 이미지레이어, 하나 이상의 볼륨 마운트와 바인드 마운트를 컨테이너에 연결 가능
- 기록 가능 레이어는 하나밖에 가질수 없다

**고려점**
- 기록 가능 레이어
    - 비용이 비싼 계산, 네트워크를 통해 저장해야하는 데이터의 캐싱등
    - 단기 저장에 적합. 컨테이너 삭제되면 여기 저장된 데이터는 유실
- 로컬 바인드 마운트
    - 호스트와 컨테이너 간 데이터 공유
    - 로컬 컴퓨터에서 수정한 내용이 이미지 빌드 없이 즉시 컨테이너로 전달 가능
- 분산 바인드 마운트
    - 네트워크 스토리지와 컨테이너 간 데이터 공유
    - 가용성이 높지만 로컬 디스크와 비교해 지원하지 않는 파일 시스템 기능이 있거나 성능면에서 차이가 있을 수 있음.
    - 읽기 전용으로 설정 파일을 전달, 공유 캐시로 활용 가능
    - 읽기 쓰기 가능으로 데이터를 저장. 동일 네트워크 상의 모든 컨테이너나 컴퓨터와 데이터를 공유하는 데 적합
- 볼륨 마운트
    - 컨테이너와 도커 객체인 볼륨간의 데이터 공유
    - 애플리케이션이 볼륨에 데이터를 영구적으로 저장
    - 컨테이너를 교체해도 볼륨은 유지
- 이미지 레이어
    - 컨테이너의 초기 파일 시스템 구성
    - 적층 구조
    - 후속 레이어와 이전 레이어 내용이 충돌하는 경우 후속 레이어의 내용 적용
    - 읽기 전용. 여러 컨테이너가 공유
