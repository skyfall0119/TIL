# 이미지 공유하기
- 이미지를 가지고 있지 않아도 도커가 자동으로 이미지를 다운받아 줌

- 내려받은 이미지는 도커 레지스트리(서버. ex 도커허브)에 있음
- 도커 허브는 도커 엔진에 기본으로 설정된 레지스트리
- 도커 이미지 이름. 총 4개의 요소로 구성됨.
    - `docker.io/diamol/golang:latest`
    - docker.io : dlalwlrk wjwkdehls fpwltmxmfl ehapdls
    - diamol : 이미지 작성자 계정이름.
    - golang : 이미지 레포지토리 이름. 일반적으로 애플리케이션 이름
    - :latest : 이미지태그 .애플리케이션의 버전

- 큰 회사는 사내 네트워크나 전용 클라우드 환경에 도커 레지스트리를 별도로 꾸릴 수 있음

- 태그는 기본적으로 latest 부과.
- 항상 최신버전일 수 없기 때문에 태그를 명시적으로 지정해줘야 함

---
### 도커 허브에 이미지 푸시하기
- 도커허브 계정 필요
- 도커 명령행을 통해 레지스트리에 로그인
- 이미지에 푸시권한을 가진 계정명을 포함하는 이미지 참조 붙이기
- 환경변수로 도커아이디를 설정해놓았음.
    - $dockerId="도커허브계정이름" (윈도우)
    - export dockerId="도커허브계정이름" (리눅스)

```
기존 이미지에 이미지 참조 부여
docker image tag [IMAGE] $dockerId/image-gallery:v1

이미지 참조 출력
docker image ls --filter reference=[IMAGE] --filter referenct=[IMAGE]
# 물리적으로는 같은 이미지 레이어를 공유.

이미지를 레지스트리에 푸시
docker image push $dockerId/image-gallery:v1

```
- 도커 레지스트리도 로컬 컴퓨터에서 동작하는 도커 엔진과 같은 방식으로 이미지 레이어를 다룸

- 이미지 푸시할때 실제 업로드 대상은 이미지 레이어
- 레지스트리에서도 캐시상에 레이어 해시와 일치하는 레이어가 없는 경우에만 실제 업로드
    - 그만큼 Dockerfile 스크립트 최적화가 더욱 중요

```
웹에서 도커 허브에 푸시된 이미지 체크
echo "https://hub.docker.com/r/$dockerId/image-gallery/tags"
```
### 나만의 도커 레지스트리 운영하기
- 깃허브 docker/distribution 에서 개발이 진행됨

```
실습용 레지스트리 컨테이너
# localhost:5000 으로 이미지태크를 부여하면 여기에 이미지 푸시 가능
docker container run -d -p 5000:5000 --restart always diamol/registry

# 도메인 네임을 별명으로 붙이는 명령
# 도메인과 IP 주소의 연결을 기록한 hosts 파일에 새로운 도메인 주소 쌍을 추가
# 윈도 파워셀
Add-Content -Value "127.0.0.1 registry.local" -Path /windows/system32/drivers/etc/hosts

# 리눅스 / macOS
echo $'\n127.0.0.1 registry.local' | sudo tee -a /etc/hosts

이제 도메인 네임 (registry.local:5000)으로 이미지 참조 태그 부여 가능. 
```
- 인증 수단 없음
- 소규모 팀에서는 상당히 유효함
- 이 레지스트리 컨테이너는 HTTPS 대신 비보안 HTTP 를 사용
- 도커 기본설정에서 비보안 프로토콜이 적용된 레지스트리를 사용할수 없게 되어있음
- 로컬 컴퓨터의 레지스트리를 비보안 레지스트리 허용 목록에 추가해야 함 (도커 설정)

> **도커 설정**
- 이미지 레이어의 저장경로, 도커 API 가 주시하는 포트 번호, 허용된 비보안 레지스트리 목록 등
- daemon.json 이라는 설정파일에 있음
- C:\ProgramData\docker\config or /etc/docker
- 도커 데스크톱을 사용중이면 UI 에서 설정 수정 가능
    - Setting -> docker engine 에 추가
    {
        "insecure-registries": ["registry.local:5000"]
    }

- 설정 수정 후 도커 엔진 재시작
    - Restart-Service docker (윈도우)
    - service docker restart (리눅스)

- docker info 로 레지스트리 관련설정 확인
```
Insecure Registries:
  registry.local:5000
  hubproxy.docker.internal:5555
  ::1/128
  127.0.0.0/8
```

%%%%% 비보안 레지스트리 주의
- 도커엔진과 레지스트리 통신내용을 엿볼수 있음
- 이미지 푸시 과정에서 레이어가 유출될수 있음
- 레지스트리에서 이미지를 받아올때 위조된 가짜 이미지를 받아올 수도 있음
- 모든 상업용 레지스트리, 오픈소스 레지스트리도 HTTPS 사용중

이제 이미지 푸시 가능  
`docker image push registry.local:5000/gallery/ui:v1`

---
### 이미지 태그 효율적으로
- 태그에는 어떤 문자열이라도 포함 가능
- 여러개 태그 부여 가능
- 태그를 통해 버전 구별
- 기본적인 방법 `[major].[minor].[patch]`
    - patch = 버그수정
    - minor = 추가적인 기능 (기존 기능 유지)
    - major = 완전히 다른 기능을 가짐

- 가능한 정확한 버전 지정이 필요
---
### 공식 이미지에서 골든 이미지로 전환
- 도커 허브는 검증된 퍼블리셔와 공식 이미지 제도를 통해 해커 피해 방지
- 검증된 퍼블리셔
    - 마이크로소프트, 오라클 등
    - 취약점 탐지 등의 승인 절차를 거쳐 이미지 공개
    - 도커와 해당 퍼블리셔의 지원을 받을수 있다는 의미

- 공식 이미지
    - 오픈소스 소프트웨어
    - 해당 프로젝트 개발팀과 도커가 함께 이미지 관리
    - 취약점 탐색 거친 후 주기적 업데이트
    - 오픈소스, 깃허브 저장소에서 Dockerfile 스크립트 확인 가능

- 직접 빌드한 이미지를 사용하다 보면 좀더 많은 것을 통제할 필요 있음
- 자신이 선호하는 기반 이미지로 전환 (골든 이미지)

**골든이미지**
- 공식 이미지를 기반 이미지로 삼아 인증서나 환경 설정값 등 자신이 필요한 설정을 추가
- 멀티 스테이지 빌드 같은 자체적으로 빌드시킨 이미지
- 도커 허브 기업 리포지터리나 자체 리포지터리에서 관리됨














