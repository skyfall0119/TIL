Image
===
*https://github.com/gilbutITbook/080258/tree/main/ch03*

커맨드
```
이미지 리스트
docker images

이미지 받기
docker image pull [docker_container image]
```
- 하나의 이미지는 여러 이미지가 계층적으로 쌓인 형태로 저장됨 (이미지 레이어)
- 물리적으로 여러개의 작은 파일로 구성됨
- 도커가 이 파일들을 조립해 컨테이너의 내부 파일 시스템을 만듦
- 모든 레이어가 다운받아진 후에 이미지 사용 가능

    `docker container run -d --name web-ping diamol/ch03-web-ping`

    --name = 컨테이너에 이름 지정

- 컨테이너를 실행할때 환경변수 설정 가능 --env (-e)

    `docker container run --env TARGET=google.com diamol/ch03-web-ping`

---
<br/>

    도커 이미지는 설정값의 기본값을 포함해 패키징되지만, 컨테이너를 실행할 때 이 설정값을 바꿀수 있어야 한다.

<br/>

-------

### Dockerfile 작성하기
- 애플리케이션을 패키징하기 위한 스크립트

#### *인스트럭션*
```
# FROM
- 모든 이미지는 다른 이미지로부터 출발

# ENV
- 환경 변수값을 지정하기 위한 인스트럭션
- [KEY]="[VALUE]" 형식

# WORKDIR
- 컨테이너 이미지 파일 시스템에 디렉터리 만들고 해당 디렉터리를 작업 디엑터리로 지정
- ex: /web-ping

# COPY
- 로컬 파일 시스템의 파일 혹은 디렉터리를 컨테이너 이미지로 복사하는 인스트럭션
- [원본경로] [복사경로]
- ex: app.js .  (로컬 파일시스템의 app.js 를 이미지의 작업디렉토리로)

# CMD
- 도커가 이미지로부터 컨테이너를 실행했을때 실행할 명령 지정
- ex: ["node", "/web-ping/app.js"]

```
<br/>

------

### 컨테이너 이미지 빌드

    docker image build --tag web-ping .

- --tag = 이미지 이름 (-t)
- 뒤의 "." 은 Dockerfile 및 이미지에 포함시킬 파일 경로 (. 은 현재 경로)
- Dockerfile 스크립트에 포함된 인스트럭션이 차례로 실행되며 그 결과 출력
- 빌드된 이미지는 로컬 이미지 캐시에 저장

이미지확인 (w 로 시작하는..)

`docker image ls 'w*'`

### 도커 이미지와 이미지 레이어 
- 이미지에는 패키징에 포함시킨 모든 파일
- 이미지 자신에 대한 여러 메타데이터 정보 포함
- 이미지가 어떻게 빌드됐는지에 대한 간단한 이력 포함

`docker image history web-ping`

- 한줄마다 한 레이어에 대한 정보 출력
- CREATED BY = 해당 레이어를 구성한 Dockerfile 스크립트의 인스트럭션
- 도커 인스트럭션과 이미지 레이어는 1:1 관계
- *도커 이미지는 이미지 레이어가 모인 논리적 대상*
- 레이어는 도커 엔진의 캐시에 물리적으로 저장된 파일
- 이미지 레이어는 여러 이미지와 컨테이너에서 공유됨

```
other-node-app                             web-ping
|------------|      |------------|      |------------| 
| server.js  |      |diamol/node |      |  app.js    |    
|            |      |            |      |            | 
|ㅁㅁㅁㅁㅁㅁㅁ| <--- |  Node.js   | ---> |ㅁㅁㅁㅁㅁㅁㅁ|
|ㅁㅁㅁㅁㅁㅁㅁ| <--- |기반 운영체제 | ---> |ㅁㅁㅁㅁㅁㅁㅁ|
|------------|      |------------|      |------------|
```
- docker image ls 로 확인했을때 각각의 이미지들은 사이즈가 커보임
- 공유된 레이어를 포함한 논리적인 이미지 크기

`docker system df`

- 실제 사용된 디스크 용량 확인
- 같은 기반 레이어를 공유하는 애플리케이션의 숫자가 많을수록 절약 가능
- 공유되는 레이어는 수정할수 없어야 함 (공유하는 다른 이미지에게도 영향)
- 도커는 이미지 레이어를 읽기 전용으로 만들어서 방지

### 이미지 레이어 캐시를 이용한 Dockerfile 스크립트 최적화
- dockerfile 의 인스트럭션은 각각 하나의 이미지레이어와 1:1 매칭
- 인스트럭션의 결과가 이전빌드와 같다면 이전에 캐시된 레이어 재사용
- 캐시에 일치하는 레이어가 있는지 확인하기 위해 해시값 사용
- 기존 이미지 레이어에 해시값이 일치하지 않으면 캐시미스 -> 해당 인스트럭션 실행
- 한번 인스트럭션이 실행되면 그다음 오는 인스트럭션은 수정 없어도 모두 실행됨
    - "각 레이어는 이전레이어 + 현재 인스트럭션의 결과물이기 때문"

- 최적화
    - 수정할 일이 잘 없을 레이어를 앞부분에 배치
    - ENV 인스트럭션 하나로 여러 환경변수 정의 (하나로 합치기)
    
